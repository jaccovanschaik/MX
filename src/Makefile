# Makefile.
#
# Copyright:	(c) 2014 Jacco van Schaik (jacco@jaccovanschaik.net)
# Version:	$Id: Makefile 408 2017-02-13 11:24:13Z jacco $
#
# This software is distributed under the terms of the MIT license. See
# http://www.opensource.org/licenses/mit-license.php for details.

.PHONY: tags version.h

all: libmx.a libmx.so mx

include tests/tests.mk

JVS_TOP = $(HOME)
JVS_INC = -I$(JVS_TOP)/include
JVS_LIB = -L$(JVS_TOP)/lib -ljvs

INSTALL_TOP = $(HOME)
INSTALL_BIN = $(INSTALL_TOP)/bin
INSTALL_INC = $(INSTALL_TOP)/include
INSTALL_LIB = $(INSTALL_TOP)/lib

MAKE_ALIB = ar rv
MAKE_SLIB = gcc -shared -o

LIBMX = libmx.o msg.o evt.o cmd.o
MX = mx.o libmx.a

CFLAGS = -g $(JVS_INC) -fPIC -Wall -O3

libmx.a: $(LIBMX)
	$(MAKE_ALIB) $@ $(LIBMX)

libmx.so: $(LIBMX)
	$(MAKE_SLIB) $@ $(LIBMX) $(JVS_LIB)

mx: $(MX)
	$(CC) $(CFLAGS) -o mx $(MX) $(JVS_LIB) -lpthread -lm

msg.c: msg.txt Makefile
	./gen_enum -c -t "" -p MX_MT -n NUM_MX_MESSAGES $< > $@

msg.h: msg.txt Makefile
	./gen_enum -h -t "" -p MX_MT -n NUM_MX_MESSAGES $< > $@

evt.c: evt.txt Makefile
	./gen_enum -c -t MX_EventType -p MX_ET -n NUM_EVENTS $< > $@

evt.h: evt.txt Makefile
	./gen_enum -h -t MX_EventType -p MX_ET -n NUM_EVENTS $< > $@

cmd.c: cmd.txt Makefile
	./gen_enum -c -t MX_CommandType -p MX_CT -n NUM_COMMANDS $< > $@

cmd.h: cmd.txt Makefile
	./gen_enum -h -t MX_CommandType -p MX_CT -n NUM_COMMANDS $< > $@

version.h:
	-svn update && echo "#define VERSION \"`svnversion`\"" > version.h

clean:
	rm -f *.o libmx.a libmx.so mx core libmx.tgz version.h \
            msg.[ch] evt.[ch] cmd.[ch] *.log $(CLEAN)

test: mx libmx.a $(TESTS)

%: %.c libmx.a
	$(CC) -I. $(CFLAGS) -o $@ $^ $(JVS_LIB) libmx.a -lm -lpthread

base: $(BASES)

%.base: %.test
	cp $< $@

libmx.tgz: clean
	tar cvf - `ls | grep -v libmx.tgz` | gzip > libmx.tgz

install: libmx.a libmx.so mx
	if [ ! -d $(INSTALL_BIN) ]; then mkdir -p $(INSTALL_BIN); fi
	cp mx $(INSTALL_BIN)
	if [ ! -d $(INSTALL_LIB) ]; then mkdir -p $(INSTALL_LIB); fi
	cp libmx.a libmx.so $(INSTALL_LIB)
	if [ ! -d $(INSTALL_INC) ]; then mkdir -p $(INSTALL_INC); fi
	cp libmx.h $(INSTALL_INC)

tags:
	ctags --c-kinds=+p -R . $(JVS_TOP)/include /usr/include

# Dependencies - generated by deps on Mon Jan 16 10:03:18 CET 2017

evt.o: evt.c evt.h 
libmx.o: libmx.c types.h libmx.h msg.h cmd.h evt.h 
msg.o: msg.c msg.h 
mx.o: mx.c types.h msg.h cmd.h evt.h libmx.h version.h 
